<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annonce Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Bootstrap Container -->
    <div class="container-fluid">
        <div class="row">
            <div class="col-12 text-center my-4">
                <h1>Annonce Dashboard</h1>
            </div>
        </div>

        <!-- Dropdown for selecting filter type -->
        <div class="row justify-content-center mb-4">
            <div class="col-md-6">
                <label for="filter" class="form-label">Select Filter:</label>
                <select id="filter" class="form-select" onchange="updateChart()">
                    <option value="state">By State</option>
                    <option value="date">By Date</option>
                    <option value="price">By Price</option>
                    <option value="size">By Size</option> <!-- Added size filter -->
                </select>
            </div>
        </div>

        <!-- Chart Container for Dynamic Filtered Data -->
        <div class="row justify-content-center">
            <div class="col-md-10 col-lg-8">
                <h2 class="text-center mb-4">Filtered Announcements</h2>
                <canvas id="filteredChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Parse the data from Django context
        const dateData = JSON.parse('{{ date_data | escapejs }}');
        const priceData = JSON.parse('{{ price_data | escapejs }}');
        const stateData = JSON.parse('{{ state_data | escapejs }}');
        const sizeData = JSON.parse('{{ size_data | escapejs }}');  // Added size data

        // Initial chart data - Default to "By State"
        let currentData = stateData;
        let chartType = 'bar'; // Default chart type

        // Create the chart
        const ctx = document.getElementById('filteredChart').getContext('2d');
        let filteredChart = new Chart(ctx, {
            type: chartType,
            data: {
                labels: currentData.labels,
                datasets: [{
                    label: 'Number of Announcements',
                    data: currentData.counts,
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                onClick: function(evt) {
                    // Get the clicked data
                    const activePoint = filteredChart.getElementsAtEventForMode(evt, 'nearest', {intersect: true}, true)[0];
                    if (activePoint) {
                        const clickedLabel = filteredChart.data.labels[activePoint.index];
                        
                        // Redirect to the new page with the clicked value as a parameter
                        window.location.href = `/annonces/details/${clickedLabel}/`;
                    }
                }
            }
        });

        // Function to update the chart based on filter selection
        function updateChart() {
            const filter = document.getElementById('filter').value;

            if (filter === 'state') {
                currentData = stateData;
                chartType = 'bar';
            } else if (filter === 'date') {
                currentData = dateData;
                chartType = 'bar';
            } else if (filter === 'price') {
                currentData = priceData; // Use the updated price data
                chartType = 'bar';
            } else if (filter === 'size') {  // Added size filter case
                currentData = sizeData;
                chartType = 'bar';
            }

            // Destroy the current chart and create a new one with updated data
            filteredChart.destroy();
            filteredChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: currentData.bins || currentData.labels,  // Price data uses bins, others use labels
                    datasets: [{
                        label: 'Number of Announcements',
                        data: currentData.counts,
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    onClick: function(evt) {
                        // Get the clicked data
                        const activePoint = filteredChart.getElementsAtEventForMode(evt, 'nearest', {intersect: true}, true)[0];
                        if (activePoint) {
                            const clickedLabel = filteredChart.data.labels[activePoint.index];

                            // Get the selected filter type (from the dropdown)
                            const filterType = document.getElementById('filter').value;

                            // Redirect to the new page with the clicked value and filter type as parameters
                            window.location.href = `/annonces/details/${clickedLabel}/?filter_type=${filterType}`;
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
